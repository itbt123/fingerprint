<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Check-In/Out System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Custom styles */
        .card-body {
            background-color: #f0f0f08e;
            box-shadow: 0px 0px 1px 1px #6161618c;
            border-radius: 8px;
            border: 1px solid #080052;
        }

        .action-info p {
            font-size: 1.2rem;
        }

        .action-info .label {
            font-weight: bold;
        }

        .action-info .value {
            color: blue;
        }

        .map-link {
            word-wrap: break-word;
        }

        .status-message {
            font-size: 1.3rem;
            font-weight: bold;
            color: #dc3545;
        }

        .modal-dialog {
            max-width: 450px;
        }

        .btn {
            width: 100%;
            background-color: #007bff;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
        }

        .main-header {
            font-family: 'Arial', sans-serif;
            color: #343a40;
        }

        .card-title mark {
            /* background-color: #ffc107; */
            color: #212529;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container mt-5 main-header">
        <h1 class="text-center main-content" style="text-decoration: underline;">Fingerprint Check-In/Out</h1>
        <div class="card mt-4">
            <div class="card-body">

        <!-- User Name Input -->
        <div class="mb-3 mt-4">
          <label for="userNameInput" class="form-label">á‡áŸ’ášá¾áŸášá¾áŸá¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</label>
          <select id="userNameInput" class="form-select" required>
            <option value="" disabled selected>á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€!</option>
            <option value="áŸáŸ… áŸá˜áŸ’á”ááŸ’áá·">áŸáŸ… áŸá˜áŸ’á”ááŸ’áá·(0163)</option>
            <option value="áŒá¹á˜ áŸá»á‡á¶áá·">áŒá¹á˜ áŸá»á‡á¶áá·(0158)</option>
            <option value="áŸáŸ€á„ áŸá¶ášá»á">áŸáŸ€á„ áŸá¶ášá»á(0151)</option>
            <option value="á†á“ ášááŸ’áá“áŸˆ">á†á“ ášááŸ’áá“áŸˆ(0243)</option>
            <option value="á˜áŸ‰á»á› á“á¸áá¶">á˜áŸ‰á»á› á“á¸áá¶(0242)</option>
            <option value="áŸá¹á˜ áŸá»á">áŸá¹á˜ áŸá»á(0250)</option>
            <option value="á•á¼ áŸá»áá“á¸">á•á¼ áŸá»áá“á¸(0254)</option>
            <option value="á¡áŸá„ áŒá¿á“">á¡áŸá„ áŒá¿á“(0169)</option>
            <option value="áœááŸ’á áŠá¶ááŸ‚á">áœááŸ’á áŠá¶ááŸ‚á(0172)</option>
            <option value="áœáŸ‰á¶á“ áŸá¶ášáŸ‰áŸá">áœáŸ‰á¶á“ áŸá¶ášáŸ‰áŸá(0062)</option>
            <option value="á‚áº á‘áºá€á¡á¶">á‚áº á‘áºá€á¡á¶(0183)</option>
            <option value="á›á¸ áŸáŸ€á„á¢á»á¸">á›á¸ áŸáŸ€á„á¢á»á¸(0224)</option>
            <option value="á˜áŸ‰á»á„ áŠá¶á›á¸á“">á˜áŸ‰á»á„ áŠá¶á›á¸á“(0066)</option>
            <option value="á—á¿á“ áŠá¶á›á¸á“">á—á¿á“ áŠá¶á›á¸á“(0016)</option>
            <option value="á”á¿á“ á€á‰áŸ’á‰á¶">á”á¿á“ á€á‰áŸ’á‰á¶(0238)</option>
            <!-- Add more options as needed -->
          </select>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Include Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
                // Get the visit count and last visit timestamp from localStorage
        let visitCount = localStorage.getItem('visitCount');
        let lastVisitTime = localStorage.getItem('lastVisitTime');
        const currentTime = new Date().getTime(); // Current time in milliseconds

        // If there's no last visit timestamp, initialize the visit count
        if (!lastVisitTime) {
            lastVisitTime = currentTime;
            visitCount = 0; // Start fresh with 0 visits
        }

        // Check if 1 minute has passed since the last visit
        const timeDifference = currentTime - lastVisitTime;
        const oneMinute = 60 * 1000; // 1 minute in milliseconds

        if (timeDifference > oneMinute) {
            // Reset visit count after 1 minute
            visitCount = 1;
            lastVisitTime = currentTime; // Update last visit time
        } else {
            // Increment visit count if within the same minute window
            visitCount = parseInt(visitCount) + 1;
        }

        // Update localStorage with new visit count and timestamp
        localStorage.setItem('visitCount', visitCount);
        localStorage.setItem('lastVisitTime', lastVisitTime);

        // Check if the visit count exceeds 4
        if (visitCount > 1) {
            document.body.innerHTML = "<h1>á¢áŸ’á“á€á–á·áá‡á¶áá¼á…ááŸ’á›á¶áŸ†á„áá¶áŸáŸ‹áŠáŸ‚á›á áŸŠá¶á“ copy Link áŸáŸ’á€áŸá“á˜áŸ’áá„á‘áŸ€áğŸ¤£</h1>";
            // Optionally, you can redirect or block further page interaction
        }
            $(document).ready(function() {
                $('#userNameInput').select2({
                    placeholder: "á‡áŸ’ášá¾áŸášá¾áŸáˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€!",
                    allowClear: true
                }).on('change', function() {

                });
            });
            
        </script>
        </div>
        <!-- Action Selection Dropdown -->
        <div class="mb-3">
          <label for="actionSelect" class="form-label">á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“ </label>
          <select id="actionSelect" class="form-select" required>
            <option value="Check-In">áŸáŸ’á€áŸá“á…á¼á›</option>
            <option value="Check-Out">áŸáŸ’á€áŸá“á…áŸá‰</option>
          </select>
        </div>

        <button id="scanFingerprint" class="btn btn-primary mb-3">á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸáŸ’á€áŸá“</button>

        <!-- Action Information -->
        <div class="action-info">
          <p><span class="label">á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“áŸ–</span> <span id="action" class="value">N/A</span></p>
          <p><span class="label">ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„áŸ–</span> <span id="timestamp" class="value">N/A</span></p>
          <p><span class="label">á€á¶ášá…á¶á”áŸ‹á‘á¸áá¶áŸ†á„ášá”áŸáŸ‹á¢áŸ’á“á€áŸ–</span> <span id="location" class="value">Fetching
              location...</span></p>
          <p><span class="label">á‘á¸áá¶áŸ†á„ášá”áŸáŸ‹á¢áŸ’á“á€áŸ–</span> <a id="mapLink" class="map-link" href="#" target="_blank">View
              on Map</a></p>
        </div>
        <!-- Status Message -->
        <p id="status" class="status-message text-muted">ášá„á…á¶áŸ†á€á¶ášáŸáŸ’á€áŸá“ášá”áŸáŸ‹á¢áŸ’á“á€...</p>
      </div>
    </div>
  </div>
  <!-- <script>
    // Prevent navigation away from the current page
    window.onbeforeunload = function() {
      return "Are you sure you want to leave this page?";
    };
  
    // Optional: You can change the page URL after the page load (e.g., hide part of the URL)
    window.history.pushState({}, "", "/");
  </script> -->
  
  <script>
    const userState = {};



// Allowed location and tolerance
const allowedLatitude = 11.562778;
const allowedLongitude = 104.918222;
// const tolerance = 0.01; // 0.000009 degrees ~ 1 meter

// Get user's location
const locationElement = document.getElementById('location');
const mapLinkElement = document.getElementById('mapLink');
const scanButton = document.getElementById('scanFingerprint');

let isWithinBounds = false;
let currentLatitude = 0;
let currentLongitude = 0;

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      currentLatitude = latitude;
      currentLongitude = longitude;

      locationElement.textContent = `Lat: ${latitude.toFixed(5)}, Long: ${longitude.toFixed(5)}`;
      mapLinkElement.href = `https://www.google.com/maps?q=${latitude},${longitude}`;

      // Check if user is within allowed location bounds
      isWithinBounds =
        Math.abs(latitude - allowedLatitude) <= tolerance &&
        Math.abs(longitude - allowedLongitude) <= tolerance;

      if (!isWithinBounds) {
        locationElement.textContent += " (á‘á¸áá¶áŸ†á„á“áŸáŸ‡á˜á·á“ááŸ’ášá¹á˜ááŸ’ášá¼áœá‘áŸ!)";
        mapLinkElement.textContent = "á˜á·á“á¢á¶á…áŸáŸ’á€áŸá“á‘á¸áá¶áŸ†á„á”á¶á“á‘áŸ!";
        scanButton.style.display = 'none'; // Hide the button if location is incorrect
        alert("á¢áŸ’á“á€á˜á·á“á¢á¶á…áŸáŸ’á€áŸá“á”á¶á“á‘áŸ! áŸá¼á˜á˜á€á€á“áŸ’á›áŸ‚á„á’áŸ’áœá¾á€á¶ášášá”áŸáŸ‹á¢áŸ’á“á€áŸá·á“! á”áŸ’ášá‰á¶á”áŸ‹á¡á¾á„!");
      } else {
        scanButton.style.display = 'block'; // Show the button if location is correct
      }
    },
    () => {
      locationElement.textContent = "á˜á·á“á¢á¶á…á™á€á‘á¸áá¶áŸ†á„á“áŸáŸ‡á”á¶á“á‘áŸ!";
      mapLinkElement.textContent = "áŸá¼á˜á…á»á…ááŸ’ášá„áŸ‹á“áŸáŸ‡áŠá¾á˜áŸ’á”á¸á”á¾á€á‘á¸áá¶áŸ†á„";
      mapLinkElement.href = "#";
          scanButton.style.display = 'none'; // Hide the button if location cannot be fetched
        }
      );
    } else {
      locationElement.textContent = "Geolocation is not supported by this browser.";
      mapLinkElement.textContent = "á•áŸ‚á“á‘á¸á˜á·á“á˜á¶á“á‘áŸáŸ”";
      mapLinkElement.href = "#";
      scanButton.style.display = 'none'; // Hide the button if geolocation is not supported
    }

    document.getElementById("scanFingerprint").addEventListener("click", function (e) {
      e.preventDefault(); // Prevent the default form submission
      document.getElementById("status").textContent = "á€áŸ†á–á»á„á”á‰áŸ’á‡á¼á“";
      document.getElementById("status").style.display = "block";
      document.getElementById("scanFingerprint").disabled = true;

      // Collect the form data
      var userName = document.getElementById('userNameInput').value.trim();
      var action = document.getElementById('actionSelect').value;
      var timestamp = new Date().toLocaleString();
      var location = `Lat: ${currentLatitude.toFixed(5)}, Long: ${currentLongitude.toFixed(5)}`;

      var formData = new FormData();
      formData.append('áˆáŸ’á˜áŸ„áŸ‡', userName);
      formData.append('á”áŸ’ášá—áŸá‘áŸáŸ’á€áŸá“', action);
      formData.append('ááŸ’á„áŸƒ/á˜áŸ‰áŸ„á„', timestamp);
      formData.append('location', location);

      var keyValuePairs = [];
      for (var pair of formData.entries()) {
        keyValuePairs.push(pair[0] + "=" + pair[1]);
      }

      var formDataString = keyValuePairs.join("&");

      // Send a POST request to your Google Apps Script
      fetch(
        "https://script.google.com/macros/s/AKfycbyS-hk5UE2BJsDcZ9eshieZOcncGDTJWrnYN3cMmFj5hlFFnoBKnm1e5nX3p0A_V1xFKQ/exec",

        {
          redirect: "follow",
          method: "POST",
          body: formDataString,
          headers: {
            "Content-Type": "text/plain;charset=utf-8",
          },
        }
      )
        .then(function (response) {
          // Check if the request was successful
          if (response) {
            return response; // Assuming your script returns JSON response
          } else {
            throw new Error("Failed to submit the form.");
          }
        })
        .then(function (data) {
          // Display a success message
          document.getElementById("status").textContent =
            "á”á¶á“á”á‰áŸ’á‡á¼á“ášá½á…ášá¶á›áŸ‹";
          document.getElementById("status").style.display = "block";
          document.getElementById("status").style.backgroundColor = "gold";
          document.getElementById("status").style.color = "beige";
          document.getElementById("scanFingerprint").disabled = false;

          setTimeout(function () {
            document.getElementById("status").textContent = "";
            document.getElementById("status").style.display = "none";
          }, 2600);
        })
        .catch(function (error) {
          // Handle errors, you can display an error message here
          console.error(error);
          document.getElementById("status").textContent =
            "An error occurred while submitting the form.";
          document.getElementById("status").style.display = "block";
        });
    });

    // Function to send a message to the Telegram bot
    function sendToTelegram(message) {
      const url = `https://api.telegram.org/bot7205851039:AAHBOJmY40GvNl7M0X_FN9Ml0Fg2T_KQpb8/sendMessage`;
      const data = {
        chat_id: "-1002282814819", // Chat ID
        text: message
      };

      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(data => {
          console.log("Message sent to Telegram:", data);
        })
        .catch(error => {
          console.error("Error sending message to Telegram:", error);
        });
    }

    document.getElementById('scanFingerprint').addEventListener('click', () => {
      const scanButton = document.getElementById('scanFingerprint');
      scanButton.disabled = true; // Disable the button immediately
      scanButton.style.display = 'none'; // Hide the button

      // Store the time when the button is clicked in localStorage
      localStorage.setItem("buttonStateTime", Date.now());

      const action = document.getElementById('actionSelect').value; // Get selected action (Check-In or Check-Out)

      const statusElement = document.getElementById('status');
      const actionElement = document.getElementById('action');
      const timestampElement = document.getElementById('timestamp');

      // Get the entered user name
      const userName = document.getElementById('userNameInput').value.trim();

      if (!userName) {
        alert("áŸá¼á˜á”á‰áŸ’á‡á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€");
        scanButton.disabled = false; // Re-enable the button in case of missing name
        scanButton.style.display = 'block'; // Show the button again
        localStorage.removeItem("buttonStateTime"); // Reset localStorage
        return;
      }

      // Get the current time
      const currentTimeFormatted = new Date().toLocaleString();

      // Set action as per selected action (Check-In or Check-Out)
      if (action === "Check-Out") {
        userState[userName] = "Check-Out";
        statusElement.textContent = `áŸáŸ†áá¶á„á›áŸ’á¢, ${userName}!`;
        actionElement.textContent = "Check-Out";

        // Send message to Telegram bot with full map link
        const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
        sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked out**\n\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†/á˜áŸ‰áŸ„á„ áŸ– ${currentTimeFormatted}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
      } else {
        userState[userName] = "Check-In";
        statusElement.textContent = `áŸá¼á˜áŸáŸ’áœá¶á‚á˜á“áŸ, ${userName}!`;
        actionElement.textContent = "Check-In";

        // Send message to Telegram bot with full map link
        const mapLink = `https://www.google.com/maps?q=${currentLatitude},${currentLongitude}`;
        sendToTelegram(`áˆáŸ’á˜áŸ„áŸ‡ áŸ– ${userName}\n**Checked in**\n\nááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†â€‹ áŸ– ${currentTimeFormatted}\n[á˜á¾á›á‘á¸áá¶áŸ†á„] ${mapLink}`);
      }

      timestampElement.textContent = currentTimeFormatted;

      // Save user data to localStorage
      const userData = JSON.parse(localStorage.getItem("userData")) || [];
      userData.push({
        userName,
        action,
        timestamp: currentTimeFormatted,
        location: { latitude: currentLatitude, longitude: currentLongitude }
      });
      localStorage.setItem("userData", JSON.stringify(userData));

      // Reload the page after 1 minute to hide the button
      setTimeout(() => {
        window.location.href = window.location.href;
      }, 60000); // 1 minute = 60000 milliseconds
    });

    // Check the button state on page load
    window.addEventListener('load', () => {
      const buttonStateTime = localStorage.getItem("buttonStateTime");
      if (buttonStateTime) {
        const elapsedTime = Date.now() - buttonStateTime;
        if (elapsedTime < 60000) { // 1 minute = 60000 milliseconds
          document.getElementById('scanFingerprint').disabled = true;
          document.getElementById('scanFingerprint').style.display = 'none';
        } else {
          localStorage.removeItem("buttonStateTime");
        }
      }
    });
  </script>
</body>

<script
